<!--
 Copyright 2024 Sam Pullara

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notion to Obsidian Converter</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .config-status {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .status-ok { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        
        .databases-section {
            margin-top: 30px;
        }
        
        .database-list {
            border: 1px solid #dee2e6;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .database-item {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .database-item:hover {
            background-color: #f8f9fa;
        }
        
        .database-item.selected {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        
        .database-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .database-properties {
            font-size: 0.9em;
            color: #666;
        }
        
        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0056b3;
        }
        
        .btn-primary:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #545b62;
        }

        .btn-secondary:disabled {
            background-color: #6c757d;
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .output-path {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .loading {
            display: none;
            color: #007bff;
            font-style: italic;
        }
        
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            display: none;
        }
        
        .result.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .result.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .file-list {
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            background: rgba(255,255,255,0.5);
            padding: 10px;
            border-radius: 4px;
        }
        
        .file-item {
            font-family: monospace;
            font-size: 0.9em;
            margin-bottom: 2px;
        }

        .progress-container {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background-color: #f8f9fa;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-details {
            font-size: 0.9em;
            color: #666;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Notion to Obsidian Converter</h1>
        
        <div class="config-status" id="configStatus">
            <h3>Configuration Status</h3>
            <div class="status-item">
                <div class="status-indicator" id="notionStatus"></div>
                <span>Notion API Token</span>
            </div>
            <div class="status-item">
                <div class="status-indicator status-ok"></div>
                <span>Ready to convert to Markdown files</span>
            </div>
        </div>
        
        <div class="databases-section">
            <h3>Available Databases</h3>
            <button class="btn btn-secondary" onclick="loadDatabases()">Refresh Databases</button>
            
            <div class="database-list" id="databaseList">
                <div style="padding: 20px; text-align: center; color: #666;">
                    Click "Refresh Databases" to load your Notion databases
                </div>
            </div>
            
            <div class="controls">
                <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="useObsidianVault" onchange="toggleObsidianOptions()">
                        <label for="useObsidianVault" style="font-weight: 600;">Import directly to Obsidian vault</label>
                    </div>

                    <div id="obsidianOptions" style="display: none; padding-left: 25px; border-left: 3px solid #007bff;">
                        <div style="margin-bottom: 10px; display: flex; gap: 10px;">
                            <input type="text" class="output-path" id="obsidianVaultPath" placeholder="Path to your Obsidian vault (e.g., C:/Users/YourName/Documents/ObsidianVault)" style="flex: 1;">
                            <button type="button" class="btn btn-secondary" onclick="selectVaultFolder()" id="browseBtn">Browse...</button>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="createNotionFolder" checked>
                            <label for="createNotionFolder" style="font-size: 14px;">Create "Notion Imports" folder</label>
                        </div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                            Files will be saved to: <span id="previewPath">Vault/Notion Imports/DatabaseName/</span>
                        </div>

                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                            <label style="font-weight: 600; margin-bottom: 8px; display: block;">Conversion Format:</label>
                            <div style="margin-left: 10px;">
                                <label style="display: block; margin-bottom: 5px;">
                                    <input type="radio" name="conversionFormat" value="separate-pages" checked onchange="updateFormatDescription()">
                                    Separate pages (current method)
                                </label>
                                <label style="display: block; margin-bottom: 5px;">
                                    <input type="radio" name="conversionFormat" value="dataview-table" onchange="updateFormatDescription()">
                                    Dataview table + individual notes (recommended)
                                </label>
                                <label style="display: block; margin-bottom: 5px;">
                                    <input type="radio" name="conversionFormat" value="markdown-table" onchange="updateFormatDescription()">
                                    Single markdown table (lightweight)
                                </label>
                            </div>
                            <div class="format-description" id="formatDescription" style="font-size: 0.9em; color: #666; margin-top: 8px; padding: 8px; background-color: #f8f9fa; border-radius: 4px;">
                                Creates individual .md files for each database row (current behavior)
                            </div>
                        </div>
                    </div>

                    <div id="regularOptions">
                        <input type="text" class="output-path" id="outputPath" placeholder="Output path (default: ./output)" value="./output">

                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                            <label style="font-weight: 600; margin-bottom: 8px; display: block;">Conversion Format:</label>
                            <div style="margin-left: 10px;">
                                <label style="display: block; margin-bottom: 5px;">
                                    <input type="radio" name="conversionFormatRegular" value="separate-pages" checked onchange="updateFormatDescriptionRegular()">
                                    Separate pages (current method)
                                </label>
                                <label style="display: block; margin-bottom: 5px;">
                                    <input type="radio" name="conversionFormatRegular" value="dataview-table" onchange="updateFormatDescriptionRegular()">
                                    Dataview table + individual notes (recommended)
                                </label>
                                <label style="display: block; margin-bottom: 5px;">
                                    <input type="radio" name="conversionFormatRegular" value="markdown-table" onchange="updateFormatDescriptionRegular()">
                                    Single markdown table (lightweight)
                                </label>
                            </div>
                            <div class="format-description" id="formatDescriptionRegular" style="font-size: 0.9em; color: #666; margin-top: 8px; padding: 8px; background-color: #f8f9fa; border-radius: 4px;">
                                Creates individual .md files for each database row (current behavior)
                            </div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary" id="convertBtn" onclick="convertSelected()" disabled>
                    Convert Selected Database
                </button>
            </div>
            
            <div class="loading" id="loading">
                Converting database... This may take a few minutes for large databases.
            </div>

            <div class="progress-container" id="progressContainer" style="display: none;">
                <div class="progress-header">
                    <span id="progressMessage">Starting conversion...</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-details" id="progressDetails"></div>
            </div>
            
            <div class="result" id="result"></div>
        </div>
    </div>

    <script>
        let selectedDatabase = null;
        
        // Check configuration on page load
        window.onload = function() {
            checkConfig();
        };
        
        async function checkConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                
                const notionStatus = document.getElementById('notionStatus');
                notionStatus.className = `status-indicator ${config.notionConfigured ? 'status-ok' : 'status-error'}`;
                
                if (config.notionConfigured) {
                    loadDatabases();
                }
            } catch (error) {
                console.error('Error checking config:', error);
            }
        }
        
        async function loadDatabases() {
            const listElement = document.getElementById('databaseList');
            listElement.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Loading databases...</div>';
            
            try {
                const response = await fetch('/api/databases');
                const databases = await response.json();
                
                if (response.ok) {
                    displayDatabases(databases);
                } else {
                    listElement.innerHTML = `<div style="padding: 20px; text-align: center; color: #dc3545;">Error: ${databases.error}</div>`;
                }
            } catch (error) {
                console.error('Error loading databases:', error);
                listElement.innerHTML = '<div style="padding: 20px; text-align: center; color: #dc3545;">Failed to load databases</div>';
            }
        }
        
        function displayDatabases(databases) {
            const listElement = document.getElementById('databaseList');
            
            if (databases.length === 0) {
                listElement.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No databases found</div>';
                return;
            }
            
            listElement.innerHTML = '';
            
            databases.forEach(db => {
                const item = document.createElement('div');
                item.className = 'database-item';
                item.onclick = () => selectDatabase(db, item);
                
                item.innerHTML = `
                    <div class="database-title">${db.title}</div>
                    <div class="database-properties">Properties: ${db.properties.join(', ')}</div>
                `;
                
                listElement.appendChild(item);
            });
        }
        
        function selectDatabase(database, element) {
            // Remove previous selection
            document.querySelectorAll('.database-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Select current item
            element.classList.add('selected');
            selectedDatabase = database;
            
            // Enable convert button
            document.getElementById('convertBtn').disabled = false;
        }
        
        function toggleObsidianOptions() {
            const useObsidian = document.getElementById('useObsidianVault').checked;
            const obsidianOptions = document.getElementById('obsidianOptions');
            const regularOptions = document.getElementById('regularOptions');

            if (useObsidian) {
                obsidianOptions.style.display = 'block';
                regularOptions.style.display = 'none';
                updatePreviewPath();
            } else {
                obsidianOptions.style.display = 'none';
                regularOptions.style.display = 'block';
            }
        }

        function updatePreviewPath() {
            const vaultPath = document.getElementById('obsidianVaultPath').value || 'YourVault';
            const createFolder = document.getElementById('createNotionFolder').checked;
            const previewPath = document.getElementById('previewPath');

            const baseName = vaultPath.split(/[/\\]/).pop() || 'YourVault';
            if (createFolder) {
                previewPath.textContent = `${baseName}/Notion Imports/DatabaseName/`;
            } else {
                previewPath.textContent = `${baseName}/DatabaseName/`;
            }
        }

        function updateFormatDescription() {
            const selectedFormat = document.querySelector('input[name="conversionFormat"]:checked').value;
            const description = document.getElementById('formatDescription');

            switch (selectedFormat) {
                case 'separate-pages':
                    description.textContent = 'Creates individual .md files for each database row (current behavior)';
                    break;
                case 'dataview-table':
                    description.textContent = 'Creates individual notes + a master table file using Dataview plugin queries. Requires Dataview plugin in Obsidian.';
                    break;
                case 'markdown-table':
                    description.textContent = 'Creates a single markdown table with all data. Lightweight and works without plugins.';
                    break;
            }
        }

        function updateFormatDescriptionRegular() {
            const selectedFormat = document.querySelector('input[name="conversionFormatRegular"]:checked').value;
            const description = document.getElementById('formatDescriptionRegular');

            switch (selectedFormat) {
                case 'separate-pages':
                    description.textContent = 'Creates individual .md files for each database row (current behavior)';
                    break;
                case 'dataview-table':
                    description.textContent = 'Creates individual notes + a master table file using Dataview plugin queries. Requires Dataview plugin in Obsidian.';
                    break;
                case 'markdown-table':
                    description.textContent = 'Creates a single markdown table with all data. Lightweight and works without plugins.';
                    break;
            }
        }

        // Folder selection using File System Access API
        async function selectVaultFolder() {
            try {
                // Check if the File System Access API is supported
                if ('showDirectoryPicker' in window) {
                    const directoryHandle = await window.showDirectoryPicker({
                        mode: 'readwrite'
                    });

                    // Get the full path (this is tricky with the new API)
                    // We'll use the directory name and show a success message
                    const vaultPathInput = document.getElementById('obsidianVaultPath');
                    vaultPathInput.value = directoryHandle.name;

                    // Store the directory handle for potential future use
                    window.selectedVaultHandle = directoryHandle;

                    // Show success message
                    showResult('success', `✅ Vault folder selected: "${directoryHandle.name}". The converter will use this folder for imports.`);

                    updatePreviewPath();
                } else {
                    // Fallback for browsers that don't support the API
                    showResult('error', `
                        <strong>Folder picker not supported in this browser.</strong><br>
                        Please manually enter your Obsidian vault path.<br>
                        <small>Tip: Copy the path from your file explorer's address bar.</small>
                    `);
                }
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Error selecting folder:', error);
                    showResult('error', 'Failed to select folder. Please enter the path manually.');
                }
            }
        }

        // Add event listeners for preview updates
        document.addEventListener('DOMContentLoaded', function() {
            const vaultPathInput = document.getElementById('obsidianVaultPath');
            const createFolderCheckbox = document.getElementById('createNotionFolder');
            const browseBtn = document.getElementById('browseBtn');

            if (vaultPathInput) {
                vaultPathInput.addEventListener('input', updatePreviewPath);
            }
            if (createFolderCheckbox) {
                createFolderCheckbox.addEventListener('change', updatePreviewPath);
            }

            // Check if File System Access API is supported and update button text
            if (browseBtn) {
                if ('showDirectoryPicker' in window) {
                    browseBtn.textContent = 'Browse...';
                    browseBtn.title = 'Click to select your Obsidian vault folder';
                } else {
                    browseBtn.textContent = 'Not Supported';
                    browseBtn.disabled = true;
                    browseBtn.title = 'Folder picker not supported in this browser. Please enter path manually.';
                }
            }
        });

        let currentEventSource = null;

        function startProgressTracking(conversionId) {
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressMessage = document.getElementById('progressMessage');
            const progressPercent = document.getElementById('progressPercent');
            const progressDetails = document.getElementById('progressDetails');

            progressContainer.style.display = 'block';

            currentEventSource = new EventSource(`/api/progress/${conversionId}`);

            currentEventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);

                // Update progress bar
                progressFill.style.width = data.progress + '%';
                progressPercent.textContent = data.progress + '%';
                progressMessage.textContent = data.message;

                // Update details if available
                if (data.currentPage && data.totalPages) {
                    progressDetails.textContent = `Page ${data.currentPage} of ${data.totalPages}`;
                } else if (data.totalPages) {
                    progressDetails.textContent = `Total pages: ${data.totalPages}`;
                } else {
                    progressDetails.textContent = '';
                }

                // Close connection when complete
                if (data.stage === 'complete') {
                    currentEventSource.close();
                    currentEventSource = null;
                }
            };

            currentEventSource.onerror = function(event) {
                console.error('Progress tracking error:', event);
                currentEventSource.close();
                currentEventSource = null;
            };
        }

        async function convertSelected() {
            if (!selectedDatabase) return;

            // Generate conversion ID first
            const conversionId = Date.now().toString();

            const useObsidian = document.getElementById('useObsidianVault').checked;
            const loadingElement = document.getElementById('loading');
            const progressContainer = document.getElementById('progressContainer');
            const resultElement = document.getElementById('result');
            const convertBtn = document.getElementById('convertBtn');

            let requestBody = {};

            if (useObsidian) {
                const obsidianVaultPath = document.getElementById('obsidianVaultPath').value;
                if (!obsidianVaultPath && !window.selectedVaultHandle) {
                    showResult('error', 'Please specify your Obsidian vault path or use the Browse button');
                    return;
                }

                // If we have a directory handle from the file picker, we'll need to handle this differently
                // For now, we'll use the path or folder name
                let vaultPath = obsidianVaultPath;
                if (window.selectedVaultHandle && !obsidianVaultPath) {
                    // If only folder name is available, show a helpful message
                    showResult('error', `
                        <strong>Please enter the full path to your vault.</strong><br>
                        Selected folder: "${window.selectedVaultHandle.name}"<br>
                        <small>Due to browser security, please type or paste the complete path to this folder.</small>
                    `);
                    return;
                }

                const conversionFormat = document.querySelector('input[name="conversionFormat"]:checked').value;

                requestBody = {
                    obsidianVaultPath: vaultPath,
                    createNotionFolder: document.getElementById('createNotionFolder').checked,
                    conversionFormat: conversionFormat,
                    conversionId: conversionId
                };
            } else {
                const conversionFormat = document.querySelector('input[name="conversionFormatRegular"]:checked').value;

                requestBody = {
                    outputPath: document.getElementById('outputPath').value || './output',
                    conversionFormat: conversionFormat,
                    conversionId: conversionId
                };
            }

            // Show progress state
            loadingElement.style.display = 'none';
            progressContainer.style.display = 'none';
            resultElement.style.display = 'none';
            convertBtn.disabled = true;

            // Start progress tracking
            startProgressTracking(conversionId);

            try {
                const response = await fetch(`/api/convert/${selectedDatabase.id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const result = await response.json();

                if (response.ok) {
                    const integrationMessage = result.obsidianIntegration
                        ? '<br><strong>✅ Files imported directly to your Obsidian vault!</strong>'
                        : '';

                    showResult('success', `
                        <strong>Conversion completed successfully!</strong>${integrationMessage}<br>
                        Database: ${result.database}<br>
                        Files created: ${result.filesCreated}<br>
                        Output path: ${result.outputPath}
                        ${result.files && result.files.length > 0 ? `
                            <div class="file-list">
                                <strong>Created files:</strong><br>
                                ${result.files.map(file => `<div class="file-item">${file}</div>`).join('')}
                            </div>
                        ` : ''}
                    `);
                } else {
                    showResult('error', `Error: ${result.error}`);
                }
            } catch (error) {
                console.error('Error converting database:', error);
                showResult('error', 'Failed to convert database. Please check the console for details.');
            } finally {
                // Clean up progress tracking
                if (currentEventSource) {
                    currentEventSource.close();
                    currentEventSource = null;
                }
                progressContainer.style.display = 'none';
                convertBtn.disabled = false;
            }
        }
        
        function showResult(type, message) {
            const resultElement = document.getElementById('result');
            resultElement.className = `result ${type}`;
            resultElement.innerHTML = message;
            resultElement.style.display = 'block';
        }
    </script>
</body>
</html>
